/* Initial beliefs and rules */

environment_IRI("http://localhost:8080/environments/shopfloor").


//Item is initially free in the environment
on_ground.


//Destination set to (600,400)
destination(600,400).


inRange(ArtifactName,X,Y)
	:- location(ArtifactName,Xr,Yr) &
		range(ArtifactName,R) &
		 (X-Xr)*(X-Xr) + (Y-Yr)*(Y-Yr) <= R*R.


/*Initial goals */

!start.

/* General Plans */

/* Move item from its position to a destination */

+!start : environment_IRI(EnvIRI) <-
	.print("Hello world, I'm Transporter 2.0. Let's see if I can help in the environment: ",EnvIRI);
	.wait(1000);
	.send(node_manager, achieve, environment_loaded(EnvIRI)).


+environment_loaded(EnvIRI, WorkspacesNames) : true <-
	.print("Environment loaded: ", EnvIRI).


+item_position(X1,Y1): destination(X2,Y2) &
			X1=X2 & Y1=Y2 <-
			.print("Item is in its destination").


+item_position(X1,Y1): destination(X2,Y2) <-
		.print("Item in location (",X1,",",Y1,")");
		!deliver(X1,Y1,X2,Y2).


+location(ArtifactName,Xr,Yr) : true <-
	.print(ArtifactName, " has property location at (", Xr,",", Yr,")").


+range(ArtifactName,R) :true <-
	.print(ArtifactName, " has property range ",R).


+!deliver(X1,Y1,X2,Y2) : thing_artifact_available(_,ThingArtifactName,WorkspaceName) &
			hasAction(_,"http://example.com/Base")[artifact_name(_,ThingArtifactName)] &
			hasAction(_,"http://example.com/Gripper")[artifact_name(_,ThingArtifactName)] &
			inRange(ThingArtifactName,X1,Y1) &
			inRange(ThingArtifactName,X2,Y2) <-
			?location(ThingArtifactName,Xr,Yr);
			angularDisplacement(X1,Y1,Xr,Yr,D1);
			angularDisplacement(X2,Y2,Xr,Yr,D2);
			.print("Need Thing artifact to deliver from (",X1,",",Y1,") to (",X2,",",Y2,")");
			!deliver(ThingArtifactName,D1,D2).

			
+!deliver(X1,Y1,X2,Y2) : thing_artifact_available(_,ThingArtifactName, WorkspaceName) &
			artifact_available("www.Robot2",R2Name,WorkspaceName) &
			inRange(ThingArtifactName,X2,Y2) &
			not inRange(ThingArtifactName,X1,Y1)
			item_raised_by(RName) <- 
			?location(ThingArtifactName,X,Y);
			?range(ThingArtifactName,R);
			.print("Plan B : Ready to deliver with artifact ", R2Name, " from (",X1,",",Y1,") to (",500,",",300,")");
			move(300,400)[artifact_name(R2Name)];
			load[artifact_name(R2Name)];
			move(500,400)[artifact_name(R2Name)];
			unload[artifact_name(R2Name)];
			-+item_position(500,400).


+!deliver(X1,Y1,X2,Y2) : artifact_available("www.Robot1",R1Name,WorkspaceName) &
			artifact_available("www.Robot2",R2Name,WorkspaceName) &
			inRange(R1Name,X1,Y1) 
			not inRange(R1Name,X1,Y1) <- 
			.print("Plan A: Ready to deliver with artifact ", R1Name, " from (",X1,",",Y1,") to (",X1,",",Y2,")");
			?location(R1Name,Xr,Yr);
			?range(R1Name,R);
			angularDisplacement(X1,Y1,Xr,Yr,D1);
			angularDisplacement(X2,Y2,Xr,Yr,D2);
			//lineCircleCloseIntersection(X2,Y2,Xr,Yr,R,Xi,Yi);
			rotate(D1)[artifact_name(R1Name)];
			grasp[artifact_name(R1Name)];
			rotate(D2)[artifact_name(R1Name)];
			release[artifact_name(R1Name)];
			-item_on_ground;
			-+item_position(300,400).

+!deliver(ThingArtifactName,D1,D2): true <-
			.print("Plan C: Deliver with Thing artifact ", D1, D2, ThingArtifactName);
			//TODO: These will be events from the Thing Artifact
			+rotating(ThingArtifactName,D1);
			+grasping(ThingArtifactName);
			+rotating(ThingArtifactName,D2);
			+releasing(ThingArtifactName);
			//act("http://example.com/Base",[["http://example.com/Value", 512]])[artifact_name(ThingArtifact)];
			-+item_position(X2,Y2).


+artifact_available("www.Robot1",ArtifactName,WorkspaceName) : true <-
	.print("An artifact is available: ", ArtifactName, " in ", WorkspaceName);
	joinWorkspace(WorkspaceName,WorkspaceArtId);
	focusWhenAvailable(ArtifactName);
	?location(X,Y);
	?range(R);
	+location(ArtifactName,X,Y);
	+range(ArtifactName,R).

+artifact_available(_,ArtifactName,WorkspaceName) : true <-
	.print("An artifact is available: ", ArtifactName, " in ", WorkspaceName);
	joinWorkspace(WorkspaceName,WorkspaceArtId);
	focusWhenAvailable(ArtifactName).
	

+thing_artifact_available(ArtifactIRI, ArtifactName, WorkspaceName) : true <-
  	.print("A thing artifact is available: " , ArtifactIRI, " in workspace: ", WorkspaceName);
  	joinWorkspace(WorkspaceName, WorkspaceArtId);
	focusWhenAvailable(ArtifactName);
	+location(ArtifactName,550,400);
	+range(ArtifactName,50).


+hasAction(_,_): true <- .print("Action detected").

+rotating(D) : true <- .print("Received signal: Robot1 rotating ", D, " degrees");
			robotArmRotate("robot1",D)[artifact_name(floorMap)].

+grasping : true <- .print("Received signal: Robot1 grasping");
		robotArmGrasp("robot1")[artifact_name(floorMap)].

+releasing : true <- .print("Received signal: Robot1 releasing");
			robotArmRelease("robot1")[artifact_name(floorMap)].

+loading : true <- .print("Received signal: Robot2 loading");
			-item_free;
			driverLoad("robot2")[artifact_name(floorMap)].

+unloading : true <- .print("Received signal: Robot2 unloading");
			+item_free;
			driverRelease("robot2")[artifact_name(floorMap)].

+moving(X,Y) : true <- .print("Received signal: Robot2 moving to (",X,",",Y,")");
			driverMove("robot2",X,Y)[artifact_name(floorMap)].

+rotating(ThingArtifactName,D) : true <- .print("Received signal: ",ThingArtifactName," rotating ", D, " degrees");
					.wait(3000);
					robotArmRotate(ThingArtifactName,D)[artifact_name(floorMap)].

+grasping(ThingArtifactName) : true <- .print("Received signal: ",ThingArtifactName," grasping");
		.wait(3000);
		robotArmGrasp(ThingArtifactName)[artifact_name(floorMap)].

+releasing(ThingArtifactName) : true <- .print("Received signal: ",ThingArtifactName, " releasing");
			.wait(3000);
			robotArmRelease(ThingArtifactName)[artifact_name(floorMap)].


/*

//Plans Type B

+!consultArtifactManual(G) : artifact_available(_,ArtifactName,WorkSpace)
			& artifact_manual_available(_,ArtifactName, Manual)

//not like that but
+!consultArtifactManual : thing_artifact_available(_,ArtifactName,WorkspaceName)
			& hasProperty(_,"cartago:Manual")[artifact_name(_,ArtifactName)]
		        & hasUsageProtocol(_,"cartago:")[artifact_name(_,ArtifactName)]
	<-
*/

{ include("$jacamoJar/templates/common-cartago.asl")}
{ include("$jacamoJar/templates/common-moise.asl")}
